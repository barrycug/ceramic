<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Cover</title>
    <link rel="stylesheet" href="leaflet/leaflet.css">
    <style>
      
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      
    </style>
  </head>
  <body>
  
    <div id="map"></div>
    
    <script src="/leaflet/leaflet.js"></script>
    <script src="/kothic.js"></script>
    <script src="/osmosnimki.js"></script>
    <script>
    
      // "Default" options (possibly from command-line arguments)
      
      var options = {
        zoom: <%= @zoom != nil ? @zoom : 2 %>,
        center: new L.LatLng(
          <%= @lat != nil && @lon != nil ? @lat : 0 %>,
          <%= @lat != nil && @lon != nil ? @lon : 0 %>
        )
      };
      

      // If we used localStorage to store the last position, use that instead
      
      (function() {
      
        var lat, lon, zoom;
      
        if ((lat = parseFloat(localStorage.getItem("lat"))) &&
            (lon = parseFloat(localStorage.getItem("lon"))) &&
            (zoom = parseInt(localStorage.getItem("zoom")))) {
          options.center = new L.LatLng(lat, lon);
          options.zoom = zoom;
        }
        
      })();
      
      
      // Set up the map
      
      var map = new L.Map("map", options);
      
      map.on("moveend", function() {
        localStorage.setItem("lat", map.getCenter().lat.toString());
        localStorage.setItem("lon", map.getCenter().lng.toString());
      });
      
      map.on("zoomend", function() {
        localStorage.setItem("zoom", map.getZoom().toString());
      });
      
      
      // Inspect popup
      
      var popup = new L.Popup();
      
      map.on("zoomend", function() {
        map.closePopup();
      });
      
      map.on("click", function(e) {
        
        // Get pixel position
        
        var position = map.project(e.latlng);
        
        // Get index path
        
        var index = map.getZoom() + "/" +
                    Math.floor(position.x / 256) + "/" +
                    Math.floor(position.y / 256);
                    
        // Display popup
        
        popup.setLatLng(e.latlng);
        popup.setContent("Inspect tile: <a href=\"/" + index + "/inspect\">" + index + "</a>");
        
        map.openPopup(popup);
        
      });
      
      
      // Canvas tiles
      
      var canvasTiles = new L.TileLayer.Canvas({
        tileSize: 256
      });
      
      var kothic = new Kothic({
        buffered: false,
        styles: MapCSS.availableStyles,
        locales: ['be', 'ru', 'en']
      });
      
      function renderTile(canvas, data, zoom) {
        
        data.granularity = data.scale;
        
        data.features = data.features.map(function(feature) {
          if (feature.type === "osm") {
            feature.type = feature.geometry.type;
            feature.coordinates = feature.geometry.coordinates;
            feature.properties = feature.tags;
          } else if (feature.type === "coastline") {
            feature.type = feature.geometry.type;
            feature.coordinates = feature.geometry.coordinates;
            feature.properties = {"natural":"coastline"};
          }
          return feature;
        });
        
        kothic.render(canvas, data, zoom, function(t) {});
        
      }

      canvasTiles.drawTile = function(canvas, tilePoint, zoom) {
        
        // draw "loading" overlay
        
        var context = canvas.getContext("2d");
        
        context.fillStyle = "rgba(255, 255, 255, 0.5)";
        context.fillRect(0, 0, canvas.width, canvas.height);
        
        // load the tile
        
        var request = new XMLHttpRequest();
        
        request.onreadystatechange = function() {
          if (this.readyState == this.DONE) {
            if (this.status == 200 && this.responseText) {
              
              var data = JSON.parse(this.responseText);
              renderTile(canvas, data, zoom);
              
            }
          }
        }
        
        request.open("GET", "/" + zoom + "/" + tilePoint.x + "/" + tilePoint.y, true);
        request.send();
        
      }
      
      MapCSS.onImagesLoad = function() {
        map.addLayer(canvasTiles);
      }
      
      MapCSS.preloadSpriteImage("osmosnimki-maps", "osmosnimki.png");
      
    </script>
    
  </body>
</html>
